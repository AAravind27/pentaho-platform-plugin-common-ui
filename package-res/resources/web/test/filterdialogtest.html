<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:pho="http:/www.pentaho.com">
    <head>
        <title>Filter Dialog Test</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <link rel="stylesheet" type="text/css" href="../dojo/dijit/themes/pentaho/pentaho.css"/>

        <script type="text/javascript" src="webcontext.js?content=common-ui"></script>

        <script type="text/javascript">
            //<![CDATA[

                var djConfig = { modulePaths: {
                                dataapi: "../../dataapi",
                                'pentaho.common': "../pentaho/common"
                            },
                           parseOnLoad: true,
                           baseUrl: '../dojo/dojo/'
                           };

              //]]>
        </script>

        <script language='javascript' type='text/javascript' src='../locale/Messages.js'></script>
        <script language='javascript' type='text/javascript' src='../dojo/dojo/dojo.js.uncompressed.js'></script>
        <script language='javascript' type='text/javascript' src='../dojo/dojo/dojo-ext.js.uncompressed.js'></script>

        <script language="javascript" src="../repo/pentaho-ajax.js" type="text/javascript"></script>
        <script language="javascript" src="../repo/pentaho-thin-app.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/oop.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/app.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/controller.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/xhr.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/cda.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/models-mql.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/models-olap.js" type="text/javascript"></script>
        <script language="javascript" src="../dataapi/Xmla.js" type="text/javascript"></script>
        <script language="javascript" src="../repo/pentaho-thin-app.js" type="text/javascript"></script>
        <script language="javascript" src="../repo/state.js" type="text/javascript"></script>

        <script type="text/javascript">

            dojo.require("dojo.parser");
            dojo.require("pentaho.common.FilterDialog");

            var datasourcess = [];
    
    var dialog = null;
    
    function doload() {
    
        dojo.parser.parse();
        var da_mql = {
            name: 'da-mql',
            objectClass: pentaho.pda.MqlHandler
        };
        var da_olap = {
            name: 'da-olap',
            objectClass: pentaho.pda.OlapHandler
        };
        pentaho.myapp = {
            app: new pentaho.pda.app(),
            prior_idx: -1,
            source: {}
        };
        var moduleArray = [da_mql, da_olap];
        pentaho.myapp.app.init(moduleArray);	
        pentaho.myapp.app.moduleData['da-mql'].instance.METADATA_SERVICE_URL = CONTEXT_PATH + 'content/ws-run/metadataService';

        loadModels();

        dialog = dijit.byId('filterDialog');
        dialog.setLocalizationLookupFunction(Messages.getString);
        dialog.callbacks = [okFunc, cancelFunc];
        dialog.execute = okFunc;
        dialog.onCancel = cancelFunc;
        dialog.setSearchListLimit(200);
        dialog.registerOnSuccessCallback(okFunc);
        dialog.registerOnCancelCallback(cancelFunc);

    }

    /* Creates a filter on the current item */
    function createFilter () {
        var fieldId = document.getElementById('field-list').value;

        var filter = {
            "column":fieldId,
            "value":null,
            "combinationType":pentaho.pda.Column.OPERATOR_TYPES.AND,
            "operator":pentaho.pda.Column.CONDITION_TYPES.EQUAL
        }

        filter.value = ["Testing"];
        dialog.configureFor(filter);
        
        dialog.show();

    }

    /* popupate the list of available models */
    function loadModels() {
        // load the list of datasource models
        pentaho.myapp.app.getSources(
            //function to be called for each source as it is added
            function(source) {	
                //console.log(source);
                var list = document.getElementById('model-list'), opt = new Option( source.name, source.id );
                list.options[list.length] = opt;
                
            }
        );    
        document.getElementById('model-list').selectedIndex=-1;
    }
    
    /* displays the list of query elements from the selected data source */
    function showModelFields() {

		pentaho.myapp.source = pentaho.myapp.app.getSources({property:'id', value:document.getElementById('model-list').value});
        pentaho.myapp.source.discoverModelDetail();
        var elements = pentaho.myapp.source.getAllElements();
        var list = document.getElementById('field-list');
        // add the queryable elements to the list
        list.options.length = 0;
        for(var idx=0; idx<elements.length; idx++) {
            if(elements[idx].isQueryElement) {
                var opt = new Option( elements[idx].name, elements[idx].id );
                list.options[list.length] = opt;
            }
        }
        dialog.setDatasource(pentaho.myapp.source);
    }
    
    function okFunc() {
        alert('okFunc');
        dialog.hide();
    }

    function cancelFunc() {
        alert('cancelFunc');
        dialog.hide();
    }
    
        </script>

    </head>


    <body class="tundra body" onload="doload()">

        <!-- div id="button1" label="my button" onclick="alert(99)" dojoType="pentahocommon.button"/ -->

        Data Source:
        <br/>
        <select size="5" id="model-list" style="width:200px" onchange="showModelFields()">
        </select>
        <br>
        Click on a data source to see the field list
        <p/>
        Fields:
        <br/>
        <select size="20" id="field-list" style="width:200px" ondblclick="createFilter()">
        </select>
        <br/>
        Double click on a field to see the filter dialog for that field

        <div id="filterDialog" dojoType="pentaho.common.FilterDialog" style="width:450px">
        </div>

    </body>
  
</html>
